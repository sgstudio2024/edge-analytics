<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - 安装</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 480px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { font-size: 28px; font-weight: 700; color: #1a1a2e; margin-bottom: 8px; text-align: center; }
        .subtitle { color: #718096; font-size: 14px; text-align: center; margin-bottom: 32px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; color: #4a5568; margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.2s; background: white; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-link { background: none; color: #667eea; box-shadow: none; font-size: 13px; }
        .btn-link:hover { background: none; text-decoration: underline; transform: none; box-shadow: none; }
        .provider-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .provider-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .provider-card:hover { border-color: #667eea; }
        .provider-card.active { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); }
        .provider-icon { font-size: 32px; margin-bottom: 8px; }
        .provider-name { font-weight: 600; font-size: 14px; color: #1a1a2e; }
        .info-box { background: #f7fafc; border-radius: 10px; padding: 14px; margin-bottom: 20px; font-size: 12px; color: #718096; }
        .info-box a { color: #667eea; }
        .success-icon { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 32px; color: white; }
        .success-title { font-size: 20px; font-weight: 700; color: #1a1a2e; text-align: center; margin-bottom: 12px; }
        .success-message { color: #718096; text-align: center; margin-bottom: 24px; font-size: 14px; }
        .config-summary { background: #f7fafc; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
        .config-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
        .config-item:last-child { border-bottom: none; }
        .config-label { color: #718096; }
        .config-value { color: #1a1a2e; font-weight: 500; }
        .error-message { background: #fed7d7; color: #c53030; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 13px; display: none; }
        .error-message.show { display: block; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analytics Dashboard</h1>
        <p class="subtitle">CDN 流量分析仪表盘</p>

        <div class="error-message" id="error-message"></div>

        <div id="step1">
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="admin-username" placeholder="输入用户名 (留空则使用 admin)">
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" id="admin-password" placeholder="输入密码 (留空则使用 admin123)">
            </div>

            <div class="info-box">
                首次使用可留空用户名和密码，使用默认账户登录。后台可随时修改。
            </div>

            <button class="btn btn-primary" onclick="install()">开始使用</button>
            <button class="btn btn-link" onclick="showAdvanced()">高级配置 ▾</button>
        </div>

        <div id="step2" style="display: none;">
            <div class="form-group">
                <label>API 提供商</label>
                <div class="provider-selector">
                    <div class="provider-card active" onclick="selectProvider('cloudflare', event)">
                        <div class="provider-icon">☁️</div>
                        <div class="provider-name">Cloudflare</div>
                    </div>
                    <div class="provider-card" onclick="selectProvider('edgeone', event)">
                        <div class="provider-icon">⚡</div>
                        <div class="provider-name">EdgeOne</div>
                    </div>
                </div>
            </div>

            <div id="cloudflare-config">
                <div class="form-group">
                    <label>API Token (可选)</label>
                    <input type="password" id="cf-token" placeholder="留空则稍后配置">
                </div>
            </div>

            <div id="edgeone-config" style="display: none;">
                <div class="form-group">
                    <label>SecretId (可选)</label>
                    <input type="text" id="edgeone-secret-id" placeholder="留空则稍后配置">
                </div>
                <div class="form-group">
                    <label>SecretKey (可选)</label>
                    <input type="password" id="edgeone-secret-key" placeholder="留空则稍后配置">
                </div>
            </div>

            <button class="btn btn-primary" onclick="install()">保存并开始使用</button>
            <button class="btn btn-secondary" onclick="hideAdvanced()">返回快速设置</button>
        </div>

        <div id="step3" style="display: none;">
            <div class="success-icon">✓</div>
            <div class="success-title">安装成功！</div>
            <div class="success-message" id="success-message">Analytics Dashboard 已准备就绪</div>
            
            <div class="config-summary" id="config-summary"></div>

            <button class="btn btn-primary" onclick="goToAdmin()">进入后台</button>
            <button class="btn btn-secondary" onclick="goToHome()">进入首页</button>
        </div>
    </div>

    <script>
        let selectedProvider = 'cloudflare';
        let adminPath = '/admin';

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function showAdvanced() {
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }

        function hideAdvanced() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
        }

        function selectProvider(provider, event) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.provider-card').classList.add('active');
            
            document.getElementById('cloudflare-config').style.display = provider === 'cloudflare' ? 'block' : 'none';
            document.getElementById('edgeone-config').style.display = provider === 'edgeone' ? 'block' : 'none';
        }

        async function install() {
            const username = document.getElementById('admin-username').value.trim() || 'admin';
            const password = document.getElementById('admin-password').value || 'admin123';

            const config = {
                provider: selectedProvider,
                cloudflare: { enabled: selectedProvider === 'cloudflare', accounts: [] },
                edgeone: { enabled: selectedProvider === 'edgeone', accounts: [] }
            };

            if (selectedProvider === 'cloudflare') {
                const token = document.getElementById('cf-token').value.trim();
                if (token) {
                    config.cloudflare.accounts = [{ name: '默认账户', token, zones: [] }];
                }
            } else {
                const secretId = document.getElementById('edgeone-secret-id').value.trim();
                const secretKey = document.getElementById('edgeone-secret-key').value.trim();
                if (secretId && secretKey) {
                    config.edgeone.accounts = [{ name: '默认账户', secretId, secretKey, region: 'ap-hongkong', zones: [] }];
                }
            }

            const btn = document.querySelector('#step1 .btn-primary, #step2 .btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>正在安装...';

            try {
                const response = await fetch('/api/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, config })
                });
                const data = await response.json();

                if (data.success) {
                    adminPath = data.adminPath;
                    document.getElementById('config-summary').innerHTML = `
                        <div class="config-item"><span class="config-label">用户名</span><span class="config-value">${username}</span></div>
                        <div class="config-item"><span class="config-label">后台路径</span><span class="config-value">${data.adminPath}</span></div>
                    `;
                    localStorage.setItem('adminPath', data.adminPath);

                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                } else {
                    showError(data.error || '安装失败');
                    btn.disabled = false;
                    btn.textContent = '开始使用';
                }
            } catch (error) {
                showError('安装失败: ' + error.message);
                btn.disabled = false;
                btn.textContent = '开始使用';
            }
        }

        function goToAdmin() {
            window.location.href = adminPath + '/login.html';
        }

        function goToHome() {
            window.location.href = '/';
        }

        async function init() {
            try {
                const response = await fetch('/api/install/status');
                const data = await response.json();
                if (data.isInstalled) {
                    window.location.href = '/';
                }
            } catch (error) {
                showError('无法连接到服务器');
            }
        }

        init();
    </script>
</body>
</html>