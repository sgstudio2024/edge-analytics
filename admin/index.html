<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard - ç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3); }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .header p { opacity: 0.9; }
    .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
    .card-title { font-size: 20px; font-weight: 600; color: #1a1a2e; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f0f2f5; display: flex; align-items: center; gap: 12px; }
    .card-title .icon { font-size: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px; font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: border-color 0.2s, box-shadow 0.2s; background: #fafbfc; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); background: white; }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }
    .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(235, 51, 73, 0.4); }
    .btn-secondary { background: #e2e8f0; color: #4a5568; }
    .btn-secondary:hover { background: #cbd5e0; }
    .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }
    .provider-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .provider-card { border: 3px solid #e2e8f0; border-radius: 16px; padding: 24px; cursor: pointer; transition: all 0.3s; text-align: center; }
    .provider-card:hover { border-color: #667eea; transform: translateY(-4px); }
    .provider-card.active { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15); }
    .provider-card .provider-icon { font-size: 48px; margin-bottom: 12px; }
    .provider-card .provider-name { font-weight: 600; font-size: 18px; color: #1a1a2e; margin-bottom: 8px; }
    .provider-card .provider-desc { font-size: 13px; color: #718096; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    .status-success { background: #c6f6d5; color: #276749; }
    .status-error { background: #fed7d7; color: #c53030; }
    .status-warning { background: #fefcbf; color: #b7791f; }
    .account-item, .zone-item { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .account-item h4 { color: #1a1a2e; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .zone-item h5 { color: #4a5568; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .remove-btn { background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 18px; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
    .remove-btn:hover { background: #fed7d7; }
    .tabs { display: flex; gap: 4px; background: #f0f2f5; padding: 4px; border-radius: 12px; margin-bottom: 24px; }
    .tab { flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; border-radius: 10px; font-weight: 500; color: #718096; transition: all 0.2s; }
    .tab.active { background: white; color: #667eea; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .alert-success { background: #c6f6d5; color: #276749; }
    .alert-error { background: #fed7d7; color: #c53030; }
    .alert-info { background: #bee3f8; color: #2b6cb0; }
    .loading { display: flex; align-items: center; gap: 12px; padding: 20px; justify-content: center; }
    .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 20px; padding: 32px; max-width: 420px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; }
    .modal-icon.success { background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); }
    .modal-icon.error { background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); }
    .modal-icon.warning { background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%); }
    .modal-icon.info { background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); }
    .modal-icon.loading { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); }
    .modal-title { font-size: 22px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px; }
    .modal-message { font-size: 15px; color: #4a5568; margin-bottom: 24px; line-height: 1.6; }
    .modal-btn { padding: 12px 32px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .modal-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .modal-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .modal-btn.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
    .modal-btn.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
    .modal-btn:hover { transform: translateY(-2px); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
    .stat-item { background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 12px; text-align: center; }
    .stat-item .value { font-size: 24px; font-weight: 700; color: #667eea; }
    .stat-item .label { font-size: 13px; color: #718096; margin-top: 4px; }
    .preview-section { background: #f8fafc; border-radius: 12px; padding: 24px; margin-top: 20px; }
    .preview-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0; }
    .preview-favicon { width: 32px; height: 32px; }
    .preview-title { font-size: 18px; font-weight: 600; color: #1a1a2e; }
    footer { text-align: center; padding: 30px; color: #a0aec0; font-size: 14px; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="header">
      <h1>ğŸ”§ ç®¡ç†åå°</h1>
      <p>é…ç½® Analytics Dashboard çš„ API æä¾›å•†å’Œç½‘ç«™è®¾ç½®</p>
    </div>

    <div id="alert-container"></div>
  
  <div id="modal-overlay" class="modal-overlay">
    <div id="modal" class="modal">
      <div id="modal-icon" class="modal-icon"></div>
      <h3 id="modal-title" class="modal-title"></h3>
      <p id="modal-message" class="modal-message"></p>
      <button id="modal-btn" class="modal-btn primary" onclick="closeModal()">ç¡®å®š</button>
    </div>
  </div>

    <div class="card">
      <h2 class="card-title"><span class="icon">â˜ï¸</span> é€‰æ‹© API æä¾›å•†</h2>
      <div class="provider-selector">
        <div class="provider-card" id="provider-cloudflare" onclick="selectProvider('cloudflare')">
          <div class="provider-icon">â˜ï¸</div>
          <div class="provider-name">Cloudflare</div>
          <div class="provider-desc">ä½¿ç”¨ Cloudflare Analytics API</div>
        </div>
        <div class="provider-card" id="provider-edgeone" onclick="selectProvider('edgeone')">
          <div class="provider-icon">âš¡</div>
          <div class="provider-name">è…¾è®¯äº‘ EdgeOne</div>
          <div class="provider-desc">ä½¿ç”¨è…¾è®¯äº‘ EdgeOne API (SecretId + SecretKey)</div>
        </div>
      </div>
    </div>

    <div id="cloudflare-config" class="card">
      <h2 class="card-title"><span class="icon">â˜ï¸</span> Cloudflare é…ç½®</h2>
      
      <div class="tabs">
        <button class="tab active" onclick="showTab('cf-accounts', event)">è´¦æˆ·ç®¡ç†</button>
        <button class="tab" onclick="showTab('cf-validate', event)">Token éªŒè¯</button>
      </div>

      <div id="cf-accounts" class="tab-content active">
        <div id="cf-accounts-list"></div>
        <button class="btn btn-primary" onclick="addCloudflareAccount()">+ æ·»åŠ  Cloudflare è´¦æˆ·</button>
      </div>

      <div id="cf-validate" class="tab-content">
        <div class="form-group">
          <label>API Token</label>
          <input type="password" id="cf-validate-token" placeholder="è¾“å…¥æ‚¨çš„ Cloudflare API Token">
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="validateCloudflareToken()">éªŒè¯ Token</button>
        </div>
        <div id="cf-validate-result" style="margin-top: 20px;"></div>
      </div>
    </div>

    <div id="edgeone-config" class="card" style="display: none;">
      <h2 class="card-title"><span class="icon">âš¡</span> è…¾è®¯äº‘ EdgeOne é…ç½®</h2>
      
      <div class="alert alert-info">
        <span>â„¹ï¸</span>
        <div>
          <strong>è…¾è®¯äº‘ EdgeOne ä½¿ç”¨ SecretId + SecretKey è¿›è¡Œæ¥å£é‰´æƒï¼š</strong>
          <p style="margin-top: 8px; font-size: 13px;">
            è¯·å‰å¾€ 
            <a href="https://console.cloud.tencent.com/cam/capi" target="_blank" style="color: #667eea;">è…¾è®¯äº‘æ§åˆ¶å°</a> 
            è·å–æ‚¨çš„ API å¯†é’¥ã€‚å»ºè®®ä½¿ç”¨å­è´¦æˆ·å¯†é’¥ä»¥æé«˜å®‰å…¨æ€§ã€‚
          </p>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>SecretId</label>
          <input type="text" id="edgeone-secret-id" placeholder="è¾“å…¥æ‚¨çš„ SecretId">
        </div>
        <div class="form-group">
          <label>SecretKey</label>
          <input type="password" id="edgeone-secret-key" placeholder="è¾“å…¥æ‚¨çš„ SecretKey">
        </div>
      </div>

      <div class="form-group">
        <label>åœ°åŸŸ</label>
        <select id="edgeone-region">
          <option value="ap-hongkong">é¦™æ¸¯ (ap-hongkong)</option>
          <option value="ap-singapore">æ–°åŠ å¡ (ap-singapore)</option>
          <option value="ap-mumbai">å­Ÿä¹° (ap-mumbai)</option>
          <option value="ap-tokyo">ä¸œäº¬ (ap-tokyo)</option>
          <option value="na-silicon-valley">ç¡…è°· (na-silicon-valley)</option>
        </select>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" onclick="validateEdgeOneCredentials()">éªŒè¯å‡­è¯</button>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title"><span class="icon">ğŸŒ</span> ç½‘ç«™è®¾ç½®</h2>
      
      <div class="form-group">
        <label>ç½‘ç«™æ ‡é¢˜</label>
        <input type="text" id="website-title" placeholder="Analytics Dashboard">
      </div>
      
      <div class="form-group">
        <label>ç½‘ç«™å›¾æ ‡ URL</label>
        <input type="text" id="website-favicon" placeholder="/favicon.svg">
      </div>
      
      <div class="form-group">
        <label>ç½‘ç«™æè¿°</label>
        <textarea id="website-description" placeholder="å¤šè´¦æˆ·ã€å¤š Zone çš„æµé‡åˆ†æä»ªè¡¨ç›˜"></textarea>
      </div>

      <div class="preview-section">
        <div class="preview-header">
          <img id="preview-favicon" class="preview-favicon" src="/favicon.svg" alt="Favicon">
          <span id="preview-title" class="preview-title">Analytics Dashboard</span>
        </div>
        <p id="preview-description" style="color: #718096;">å¤šè´¦æˆ·ã€å¤š Zone çš„æµé‡åˆ†æä»ªè¡¨ç›˜</p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title"><span class="icon">âš™ï¸</span> æ›´æ–°è®¾ç½®</h2>
      
      <div class="form-group">
        <label>æ•°æ®æ›´æ–°é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
        <select id="update-interval">
          <option value="1">æ¯ 1 å°æ—¶</option>
          <option value="2">æ¯ 2 å°æ—¶</option>
          <option value="6">æ¯ 6 å°æ—¶</option>
          <option value="12">æ¯ 12 å°æ—¶</option>
          <option value="24">æ¯ 24 å°æ—¶</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title"><span class="icon">ğŸ“Š</span> ç³»ç»ŸçŠ¶æ€</h2>
      <div id="system-status">
        <div class="loading">
          <div class="spinner"></div>
          <span>åŠ è½½ä¸­...</span>
        </div>
      </div>
    </div>

    <div class="btn-group" style="justify-content: center; margin-top: 40px;">
      <button class="btn btn-success" onclick="saveAllConfig()" style="padding: 16px 48px; font-size: 16px;">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
      <button class="btn btn-primary" onclick="triggerUpdate()" style="padding: 16px 48px; font-size: 16px;">ğŸ”„ ç«‹å³æ›´æ–°æ•°æ®</button>
      <button class="btn btn-danger" onclick="resetSystem()" style="padding: 16px 48px; font-size: 16px;">ğŸ—‘ï¸ æ¢å¤åˆå§‹</button>
    </div>

    <footer>
      <p>Analytics Dashboard Admin | Powered by Cloudflare & è…¾è®¯äº‘ EdgeOne</p>
    </footer>
  </div>

  <script>
    let config = {
      provider: 'cloudflare',
      cloudflare: { enabled: true, accounts: [] },
      edgeone: { enabled: false, accounts: [] },
      website: { title: 'Analytics Dashboard', favicon: '/favicon.svg', description: '' },
      updateInterval: 2
    };
    let token = null;

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      token = urlParams.get('token');

      if (!token) {
        window.location.href = '/admin/login.html';
        return;
      }

      try {
        const verifyResponse = await fetch('/api/admin/verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const verifyData = await verifyResponse.json();
        if (!verifyData.valid) {
          window.location.href = '/admin/login.html';
          return;
        }
      } catch (error) {
        window.location.href = '/admin/login.html';
        return;
      }

      await loadConfig();
    }

    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const serverConfig = await response.json();
        config = {
          ...config,
          ...serverConfig,
          cloudflare: { enabled: true, accounts: [], ...(serverConfig.cloudflare || {}) },
          edgeone: { enabled: false, accounts: [], ...(serverConfig.edgeone || {}) }
        };
        renderConfig();
      } catch (error) {
        showModal('error', 'âœ— åŠ è½½å¤±è´¥', `æ— æ³•åŠ è½½é…ç½®: ${error.message}<br><br><small>è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚</small>`);
      }
    }

    function renderConfig() {
      document.getElementById('provider-cloudflare').classList.toggle('active', config.provider === 'cloudflare');
      document.getElementById('provider-edgeone').classList.toggle('active', config.provider === 'edgeone');
      document.getElementById('cloudflare-config').style.display = config.provider === 'cloudflare' ? 'block' : 'none';
      document.getElementById('edgeone-config').style.display = config.provider === 'edgeone' ? 'block' : 'none';
      
      document.getElementById('website-title').value = config.website?.title || '';
      document.getElementById('website-favicon').value = config.website?.favicon || '/favicon.svg';
      document.getElementById('website-description').value = config.website?.description || '';
      document.getElementById('update-interval').value = config.updateInterval || 2;

      if (config.edgeone && config.edgeone.accounts && config.edgeone.accounts.length > 0) {
        const edgeoneAccount = config.edgeone.accounts[0];
        document.getElementById('edgeone-secret-id').value = edgeoneAccount.secretId || '';
        document.getElementById('edgeone-secret-key').value = edgeoneAccount.secretKey || '';
        document.getElementById('edgeone-region').value = edgeoneAccount.region || 'ap-hongkong';
      } else {
        document.getElementById('edgeone-secret-id').value = '';
        document.getElementById('edgeone-secret-key').value = '';
        document.getElementById('edgeone-region').value = 'ap-hongkong';
      }

      renderCloudflareAccounts();
      updatePreview();
      loadStatus();
    }

    function renderCloudflareAccounts() {
      const container = document.getElementById('cf-accounts-list');
      container.innerHTML = config.cloudflare?.accounts?.map((account, accIndex) => `
        <div class="account-item">
          <h4>
            è´¦æˆ·: ${account.name}
            <button class="remove-btn" onclick="removeCloudflareAccount(${accIndex})">âœ•</button>
          </h4>
          <div class="form-group">
            <label>è´¦æˆ·åç§°</label>
            <input type="text" value="${account.name}" onchange="updateCloudflareAccount(${accIndex}, 'name', this.value)">
          </div>
          <div class="form-group">
            <label>API Token</label>
            <input type="password" value="${account.token}" placeholder="è¾“å…¥æˆ–ä¿æŒåŸ Token" onchange="updateCloudflareAccount(${accIndex}, 'token', this.value)">
          </div>
          <h5 style="margin: 16px 0 12px;">Zones</h5>
          ${account.zones?.map((zone, zoneIndex) => `
            <div class="zone-item">
              <h5>
                ${zone.domain}
                <button class="remove-btn" onclick="removeCloudflareZone(${accIndex}, ${zoneIndex})">âœ•</button>
              </h5>
              <div class="form-row">
                <div class="form-group">
                  <label>åŸŸå</label>
                  <input type="text" value="${zone.domain}" onchange="updateCloudflareZone(${accIndex}, ${zoneIndex}, 'domain', this.value)">
                </div>
                <div class="form-group">
                  <label>Zone ID</label>
                  <input type="text" value="${zone.zone_id}" onchange="updateCloudflareZone(${accIndex}, ${zoneIndex}, 'zone_id', this.value)">
                </div>
              </div>
            </div>
          `).join('') || ''}
          <button class="btn btn-secondary" onclick="addCloudflareZone(${accIndex})">+ æ·»åŠ  Zone</button>
        </div>
      `).join('') || '<p style="color: #718096;">æš‚æ— é…ç½®è´¦æˆ·</p>';
    }

    function selectProvider(provider) {
      config.provider = provider;
      config.cloudflare.enabled = provider === 'cloudflare';
      config.edgeone.enabled = provider === 'edgeone';
      renderConfig();
    }

    function showTab(tabId, e) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function addCloudflareAccount() {
      if (!config.cloudflare) config.cloudflare = { accounts: [] };
      config.cloudflare.accounts.push({ name: `è´¦æˆ· ${config.cloudflare.accounts.length + 1}`, token: '', zones: [] });
      renderCloudflareAccounts();
    }

    function removeCloudflareAccount(index) {
      config.cloudflare.accounts.splice(index, 1);
      renderCloudflareAccounts();
    }

    function updateCloudflareAccount(index, field, value) {
      config.cloudflare.accounts[index][field] = value;
    }

    function addCloudflareZone(accIndex) {
      config.cloudflare.accounts[accIndex].zones.push({ domain: '', zone_id: '' });
      renderCloudflareAccounts();
    }

    function removeCloudflareZone(accIndex, zoneIndex) {
      config.cloudflare.accounts[accIndex].zones.splice(zoneIndex, 1);
      renderCloudflareAccounts();
    }

    function updateCloudflareZone(accIndex, zoneIndex, field, value) {
      config.cloudflare.accounts[accIndex].zones[zoneIndex][field] = value;
    }

    async function validateCloudflareToken() {
      const token = document.getElementById('cf-validate-token').value.trim();
      if (!token) {
        showModal('warning', 'è¾“å…¥ä¸å®Œæ•´', 'è¯·è¾“å…¥ Cloudflare API Token æ‰èƒ½è¿›è¡ŒéªŒè¯ã€‚');
        return;
      }

      showModal('loading', 'æ­£åœ¨éªŒè¯', 'æ­£åœ¨è¿æ¥ Cloudflare APIï¼Œè¯·ç¨å€™...');

      try {
        const response = await fetch('/api/validate/cloudflare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const result = await response.json();

        if (result.valid) {
          showModal('success', 'âœ“ éªŒè¯æˆåŠŸ', `Token æœ‰æ•ˆï¼å¯è®¿é—® ${result.zones.length} ä¸ª Zoneã€‚`);
        } else {
          showModal('error', 'âœ— éªŒè¯å¤±è´¥', `åŸå› : ${result.error || 'æœªçŸ¥é”™è¯¯'}<br><br><small>è¯·æ£€æŸ¥æ‚¨çš„ Token æƒé™å’Œæ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</small>`);
        }
      } catch (error) {
        showModal('error', 'âœ— éªŒè¯å¤±è´¥', `ç½‘ç»œé”™è¯¯: ${error.message}<br><br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</small>`);
      }
    }

    async function validateEdgeOneCredentials() {
      const secretId = document.getElementById('edgeone-secret-id').value.trim();
      const secretKey = document.getElementById('edgeone-secret-key').value.trim();
      const region = document.getElementById('edgeone-region').value;

      if (!secretId || !secretKey) {
        showModal('warning', 'è¾“å…¥ä¸å®Œæ•´', 'è¯·è¾“å…¥ SecretId å’Œ SecretKey æ‰èƒ½è¿›è¡ŒéªŒè¯ã€‚');
        return;
      }

      showModal('loading', 'æ­£åœ¨éªŒè¯', 'æ­£åœ¨è¿æ¥è…¾è®¯äº‘ EdgeOne APIï¼Œè¯·ç¨å€™...');

      try {
        const response = await fetch('/api/validate/edgeone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secretId, secretKey, region })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }

        const result = await response.json();

        if (result.valid) {
          if (!config.edgeone) config.edgeone = { sites: [] };
          config.edgeone.secretId = secretId;
          config.edgeone.secretKey = secretKey;
          config.edgeone.region = region;
          config.edgeone.enabled = true;
          config.edgeone.sites = result.sites || [];
          await saveAllConfig();
          closeModal();
          showModal('success', 'âœ“ éªŒè¯æˆåŠŸ', `è…¾è®¯äº‘ EdgeOne å‡­è¯éªŒè¯é€šè¿‡ï¼<br>è´¦æˆ·: ${secretId}<br>ç«™ç‚¹æ•°: ${result.sites?.length || 0}`);
        } else {
          showModal('error', 'âœ— éªŒè¯å¤±è´¥', `åŸå› : ${result.error}<br><br><small>è¯·æ£€æŸ¥æ‚¨çš„ SecretId å’Œ SecretKey æ˜¯å¦æ­£ç¡®ã€‚</small>`);
        }
      } catch (error) {
        showModal('error', 'âœ— éªŒè¯å¤±è´¥', `ç½‘ç»œé”™è¯¯: ${error.message}<br><br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</small>`);
      }
    }

    function updatePreview() {
      const title = document.getElementById('website-title').value || 'Analytics Dashboard';
      const favicon = document.getElementById('website-favicon').value || '/favicon.svg';
      const description = document.getElementById('website-description').value || '';

      document.getElementById('preview-title').textContent = title;
      document.getElementById('preview-favicon').src = favicon;
      document.getElementById('preview-description').textContent = description;
    }

    document.getElementById('website-title').addEventListener('input', updatePreview);
    document.getElementById('website-favicon').addEventListener('input', updatePreview);
    document.getElementById('website-description').addEventListener('input', updatePreview);

    async function saveAllConfig() {
      config.website = {
        title: document.getElementById('website-title').value,
        favicon: document.getElementById('website-favicon').value,
        description: document.getElementById('website-description').value
      };
      config.updateInterval = parseInt(document.getElementById('update-interval').value);

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(config)
        });
        const result = await response.json();

        if (result.success) {
          showModal('success', 'âœ“ ä¿å­˜æˆåŠŸ', 'é…ç½®å·²æˆåŠŸä¿å­˜ï¼');
        } else {
          showModal('error', 'âœ— ä¿å­˜å¤±è´¥', `åŸå› : ${result.error}<br><br><small>è¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—è·å–æ›´å¤šè¯¦æƒ…ã€‚</small>`);
        }
      } catch (error) {
        showModal('error', 'âœ— ä¿å­˜å¤±è´¥', `ç½‘ç»œé”™è¯¯: ${error.message}<br><br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</small>`);
      }
    }

    async function triggerUpdate() {
      showModal('loading', 'æ­£åœ¨æ›´æ–°', 'æ­£åœ¨ä» API è·å–æœ€æ–°æ•°æ®ï¼Œè¯·ç¨å€™...');
      try {
        const response = await fetch('/api/update', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          showModal('success', 'âœ“ æ›´æ–°å®Œæˆ', 'æ•°æ®æ›´æ–°æˆåŠŸï¼æœ€æ–°æ•°æ®å·²ä¿å­˜ã€‚');
          loadStatus();
        } else {
          showModal('error', 'âœ— æ›´æ–°å¤±è´¥', `åŸå› : ${result.error}<br><br><small>è¯·æ£€æŸ¥ API å‡­è¯å’Œç½‘ç»œè¿æ¥ã€‚</small>`);
        }
      } catch (error) {
        showModal('error', 'âœ— æ›´æ–°å¤±è´¥', `ç½‘ç»œé”™è¯¯: ${error.message}<br><br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</small>`);
      }
    }

    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        const status = await response.json();

        document.getElementById('system-status').innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="value">${status.provider?.toUpperCase() || 'N/A'}</div>
              <div class="label">å½“å‰ Provider</div>
            </div>
            <div class="stat-item">
              <div class="value">${status.cloudflareEnabled ? 'âœ“' : 'âœ—'}</div>
              <div class="label">Cloudflare</div>
            </div>
            <div class="stat-item">
              <div class="value">${status.edgeoneEnabled ? 'âœ“' : 'âœ—'}</div>
              <div class="label">è…¾è®¯äº‘ EdgeOne</div>
            </div>
            <div class="stat-item">
              <div class="value">${status.lastUpdate ? new Date(status.lastUpdate).toLocaleString() : 'ä»æœª'}</div>
              <div class="label">æœ€åæ›´æ–°</div>
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById('system-status').innerHTML = '<div class="alert alert-error">åŠ è½½çŠ¶æ€å¤±è´¥</div>';
      }
    }

    function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    function showModal(type, title, message) {
      const overlay = document.getElementById('modal-overlay');
      const icon = document.getElementById('modal-icon');
      const titleEl = document.getElementById('modal-title');
      const messageEl = document.getElementById('modal-message');
      const btn = document.getElementById('modal-btn');

      icon.className = 'modal-icon ' + type;
      
      const icons = {
        success: 'âœ“',
        error: 'âœ—',
        warning: 'âš ',
        info: 'â„¹',
        loading: 'â³'
      };
      icon.textContent = icons[type] || 'â„¹';
      
      titleEl.textContent = title;
      messageEl.innerHTML = message;

      if (type === 'success') {
        btn.className = 'modal-btn success';
      } else if (type === 'error') {
        btn.className = 'modal-btn danger';
      } else {
        btn.className = 'modal-btn primary';
      }

      overlay.classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
      return num.toLocaleString();
    }

    document.getElementById('modal-overlay').addEventListener('click', function(e) {
      const isVerifyModal = document.getElementById('verify-modal').classList.contains('show');
      if (e.target.id === 'modal-overlay' && !isVerifyModal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !document.getElementById('verify-modal').classList.contains('show')) {
        closeModal();
      }
    });

    let verifyNum1, verifyNum2, verifyAnswer, verifyOperator;

    function startVerify() {
      const operators = ['+', '-', 'Ã—'];
      verifyOperator = operators[Math.floor(Math.random() * operators.length)];

      if (verifyOperator === 'Ã—') {
        verifyNum1 = Math.floor(Math.random() * 9) + 2;
        verifyNum2 = Math.floor(Math.random() * 9) + 2;
        verifyAnswer = verifyNum1 * verifyNum2;
      } else {
        verifyNum1 = Math.floor(Math.random() * 50) + 10;
        verifyNum2 = Math.floor(Math.random() * 30) + 5;
        if (verifyOperator === '-') {
          if (verifyNum1 < verifyNum2) [verifyNum1, verifyNum2] = [verifyNum2, verifyNum1];
          verifyAnswer = verifyNum1 - verifyNum2;
        } else {
          verifyAnswer = verifyNum1 + verifyNum2;
        }
      }

      const userAnswer = prompt(`å®‰å…¨éªŒè¯\n\nè¯·è®¡ç®—: ${verifyNum1} ${verifyOperator} ${verifyNum2} = ?\n\n(é˜²æ­¢è¯¯æ“ä½œï¼Œè¯·è¾“å…¥è®¡ç®—ç»“æœ)`);
      
      if (userAnswer === null) return;
      
      const userNum = parseInt(userAnswer.trim());
      
      if (userNum !== verifyAnswer) {
        alert(`ç­”æ¡ˆé”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${verifyAnswer}`);
        return;
      }

      if (!confirm('ç¡®å®šè¦æ¢å¤åˆå§‹çŠ¶æ€å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…ç©ºï¼')) return;

      performReset();
    }

    async function performReset() {
      showModal('loading', 'æ­£åœ¨æ¢å¤', 'æ­£åœ¨æ¸…ç©ºæ•°æ®å¹¶é‡ç½®ç³»ç»Ÿ...');

      try {
        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await response.json();

        if (data.success) {
          showModal('success', 'âœ“ é‡ç½®æˆåŠŸ', 'ç³»ç»Ÿå·²æ¢å¤åˆå§‹çŠ¶æ€ï¼Œé¡µé¢å³å°†åˆ·æ–°...');
          setTimeout(() => {
            window.location.href = '/admin/install.html';
          }, 2000);
        } else {
          showModal('error', 'âœ— é‡ç½®å¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        showModal('error', 'âœ— é‡ç½®å¤±è´¥', error.message);
      }
    }

    function resetSystem() {
      console.log('[Reset] æŒ‰é’®è¢«ç‚¹å‡»');
      
      const operators = ['+', '-', 'Ã—'];
      verifyOperator = operators[Math.floor(Math.random() * operators.length)];

      if (verifyOperator === 'Ã—') {
        verifyNum1 = Math.floor(Math.random() * 9) + 2;
        verifyNum2 = Math.floor(Math.random() * 9) + 2;
        verifyAnswer = verifyNum1 * verifyNum2;
      } else {
        verifyNum1 = Math.floor(Math.random() * 50) + 10;
        verifyNum2 = Math.floor(Math.random() * 30) + 5;
        if (verifyOperator === '-') {
          if (verifyNum1 < verifyNum2) [verifyNum1, verifyNum2] = [verifyNum2, verifyNum1];
          verifyAnswer = verifyNum1 - verifyNum2;
        } else {
          verifyAnswer = verifyNum1 + verifyNum2;
        }
      }

      console.log('[Reset] é¢˜ç›®:', verifyNum1, verifyOperator, verifyNum2, '=', verifyAnswer);

      setTimeout(function() {
        const userAnswer = prompt(`å®‰å…¨éªŒè¯\n\nè¯·è®¡ç®—: ${verifyNum1} ${verifyOperator} ${verifyNum2} = ?\n\n(é˜²æ­¢è¯¯æ“ä½œï¼Œè¯·è¾“å…¥è®¡ç®—ç»“æœ)`);
        
        console.log('[Reset] ç”¨æˆ·è¾“å…¥:', userAnswer);
        
        if (userAnswer === null) {
          console.log('[Reset] ç”¨æˆ·å–æ¶ˆ');
          return;
        }
        
        const userNum = parseInt(userAnswer.trim());
        console.log('[Reset] ç”¨æˆ·ç­”æ¡ˆ:', userNum, 'æ­£ç¡®ç­”æ¡ˆ:', verifyAnswer);
        
        if (userNum !== verifyAnswer) {
          alert(`ç­”æ¡ˆé”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${verifyAnswer}`);
          return;
        }

        if (!confirm('ç¡®å®šè¦æ¢å¤åˆå§‹çŠ¶æ€å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…ç©ºï¼')) return;

        performReset();
      }, 100);
    }

    init();
  </script>
</body>
</html>